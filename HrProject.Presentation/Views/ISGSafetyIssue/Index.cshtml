@using HrProject.Domain.Enums
@model HrProject.Presentation.ViewModels.ISGSafetyIssueViewModel

<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>
</head>

<body>
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>İş Sağlığı ve Güvenliği Hataları</h2>
                <a class="btn btn-primary" asp-action="Create">
                    <i class="fas fa-plus"></i> Hata Ekle
                </a>
            </div>
            <div class="table-responsive">
                <table id="safetyErrorsTable" class="table table-hover custom-table" style="width:100%">
                    <thead>
                        <tr>
                            <th>Açıklama</th>
                            <th>Kategori</th>
                            <th>Alt Kategori</th>
                            <th>Risk Seviyesi</th>
                            <th>Personel</th>
                            <th>Bildiren Kullanıcı</th>
                            <th>Rapor Tarihi</th>
                            <th>Resimler</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var issue in Model.Issues)
                        {
                            <tr data-issue-id="@issue.Id">
                                <td>@issue.Description</td>
                                <td>@(issue.Category?.Name ?? "Kategori Yok")</td>
                                <td>@(issue.SubCategory?.Name ?? "Alt Kategori Yok")</td>
                                <td>@(issue.RiskLevel == ISGRiskLevel.DusukRiskli ? "Düşük" : issue.RiskLevel == ISGRiskLevel.OrtaRiskli ? "Orta" : "Yüksek")</td>
                                <td>
                                    @if (issue.PersonId != null && ViewBag.Persons.ContainsKey(issue.PersonId.Value))
                                    {
                                        <a href="@Url.Action("PersonelDetail", "HumanResource", new { id = issue.PersonId })">@ViewBag.Persons[issue.PersonId.Value]</a>
                                    }
                                    else
                                    {
                                        <span>Personel Yok</span>
                                    }
                                </td>
                                <td>
                                    @if (issue.ReportedById != null && ViewBag.Users.ContainsKey(issue.ReportedById))
                                    {
                                        <span>@ViewBag.Users[issue.ReportedById]</span>
                                    }
                                    else
                                    {
                                        <span>Kullanıcı Yok</span>
                                    }
                                </td>
                                <td>@issue.ReportDate.ToString("dd.MM.yyyy")</td>
                                <td>
                                    @if (issue.Images != null && issue.Images.Any())
                                    {
                                        foreach (var img in issue.Images)
                                        {
                                            <a href="~/SafetyIssueImages/@img.ImagePath" data-fancybox="gallery-@issue.Id" data-caption="@issue.Description">
                                                <img src="~/SafetyIssueImages/@img.ImagePath" alt="Resim" style="width: 50px; height: 50px;" />
                                            </a>
                                        }
                                    }
                                    else
                                    {
                                        <span>Resim Yok</span>
                                    }
                                </td>
                                <td>
                                    <a class="btn btn-warning" asp-action="Edit" asp-route-id="@issue.Id">Düzenle</a>
                                    <form asp-action="Delete" asp-route-id="@issue.Id" method="post" style="display:inline;">
                                        <button type="submit" class="btn btn-danger">Sil</button>
                                    </form>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>$(document).ready(function () {
            var table = $('#safetyErrorsTable').DataTable({
                responsive: true,
                autoWidth: false,
                scrollX: true,
                scrollCollapse: true,
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.11.3/i18n/tr.json'
                },
                buttons: [
                    'copyHtml5',
                    'excelHtml5',
                    'csvHtml5',
                    'pdfHtml5'
                ],
                dom: '<"row"<"col-sm-12 col-md-3"l><"col-sm-12 col-md-6"f><"col-sm-12 col-md-3"B>>' +  // Sayfa uzunluğu, arama ve butonları üst tarafa yerleştirir
                    '<"row"<"col-sm-12"tr>>' +  // Tabloyu ortalar
                    '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',  // Bilgi ve sayfalama kontrollerini alt tarafa yerleştirir
                pageLength: 10,
                lengthMenu: [10, 20, 30, 50, 100, 150],
                paging: true
            });

            table.buttons().container().appendTo('#safetyErrorsTable_wrapper .col-md-6:eq(0)');

            // Fancybox initialization
            $('[data-fancybox]').fancybox({
                loop: true,
                buttons: [
                    'slideShow',
                    'fullScreen',
                    'thumbs',
                    'close'
                ],
                transitionEffect: "fade",
                protect: true
            });
        });

        $(document).on('click', '.btn-danger', function (e) {
            e.preventDefault();

            var issueId = $(this).closest('tr').data('issue-id');

            Swal.fire({
                title: 'Emin misiniz?',
                text: "Bu hatayı silmek istediğinizden emin misiniz?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Evet, sil!',
                cancelButtonText: 'İptal'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        type: 'POST',
                        url: '/ISGSafetyIssue/Delete',
                        data: { id: issueId },
                        success: function (response) {
                            if (response.success) {
                                Swal.fire(
                                    'Silindi!',
                                    'Hata başarıyla silindi.',
                                    'success'
                                ).then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire(
                                    'Hata!',
                                    'Hata silinirken bir sorun oluştu.',
                                    'error'
                                );
                            }
                        }
                    });
                }
            });
        });</script>
</body>
